# ТРИЗ-Решатель: Архитектура системы

## 1. Общее видение

**Название продукта**: ТРИЗ-Решатель (TRIZ Solver)
**Слоган**: «Нестандартное решение любой проблемы»

Интеллектуальная система, объединяющая алгоритмы АРИЗ-2010 (по книге В. Петрова) с возможностями LLM для пошагового решения изобретательских и бытовых задач.

---

## 2. Архитектура высокого уровня

```
┌─────────────────────────────────────────────────────┐
│                   КЛИЕНТСКИЙ СЛОЙ                    │
│  ┌──────────┐  ┌──────────┐  ┌───────────────────┐  │
│  │ Web SPA  │  │ Mobile   │  │ Telegram Bot      │  │
│  │ (React)  │  │ (PWA)    │  │ (быстрый вход)    │  │
│  └────┬─────┘  └────┬─────┘  └────────┬──────────┘  │
└───────┼──────────────┼────────────────┼──────────────┘
        │              │                │
        ▼              ▼                ▼
┌─────────────────────────────────────────────────────┐
│                    API GATEWAY                        │
│         (FastAPI / Django REST Framework)             │
└───────────────────────┬─────────────────────────────┘
                        │
        ┌───────────────┼───────────────┐
        ▼               ▼               ▼
┌──────────────┐ ┌─────────────┐ ┌─────────────────┐
│  АРИЗ-ENGINE │ │ LLM Service │ │ User Service    │
│  (Ядро)      │ │ (Claude API)│ │ (Auth, Profile) │
└──────┬───────┘ └──────┬──────┘ └────────┬────────┘
       │                │                  │
       ▼                ▼                  ▼
┌─────────────────────────────────────────────────────┐
│                   ХРАНИЛИЩЕ ДАННЫХ                    │
│  ┌───────────┐  ┌────────────┐  ┌────────────────┐  │
│  │PostgreSQL │  │ Redis      │  │ Vector DB      │  │
│  │(задачи,   │  │(сессии,    │  │(задачи-аналоги,│  │
│  │ пользов.) │  │ кэш)       │  │ эмбеддинги)    │  │
│  └───────────┘  └────────────┘  └────────────────┘  │
└─────────────────────────────────────────────────────┘
```

---

## 3. АРИЗ-Engine — ядро системы

Это главный компонент, реализующий алгоритмы из книги Петрова. Состоит из трёх режимов работы.

### 3.1. Режим «Экспресс» (Краткий АРИЗ, 7 шагов)

Для B2C и быстрого решения. Базируется на «Кратком АРИЗ» из Главы 3:

```
Шаг 1: Формулировка задачи
Шаг 2: Поверхностное противоречие (ПП) → выявление НЭ
Шаг 3: Углубленное противоречие (УП₁, УП₂) → выбор УП
Шаг 4: Идеальный конечный результат (ИКР)
Шаг 5: Обостренное противоречие (ОП)
Шаг 6: Углубление ОП (ОП₁)
Шаг 7: Решение → разрешение ОП (пространство/время/структура/условие)
```

### 3.2. Режим «Полный АРИЗ-2010» (4 части, ~30 шагов)

Для B2B и сложных задач. Полная реализация Главы 5:

```
ЧАСТЬ 1. АНАЛИЗ ЗАДАЧИ (шаги 1.1–1.7)
  1.1 Мини-задача (1.1.1–1.1.7)  — 16 правил
  1.2 Конфликтующая пара          — правила 17–18
  1.3 Углубленное противоречие    — правило 19
  1.4 Выбор конфликтующей пары    — правила 20–21
  1.5 Усиление конфликта          — правила 22–24
  1.6 Модель задачи
  1.7 Вепольный анализ

ЧАСТЬ 2. АНАЛИЗ РЕСУРСОВ (шаги 2.1–2.3)
  2.1 Оперативная зона (ОЗ)
  2.2 Оперативное время (ОВ)
  2.3 Вещественно-полевые ресурсы (ВПР)

ЧАСТЬ 3. ОПРЕДЕЛЕНИЕ ОП (шаги 3.1–3.6)
  3.1 Формулировка ИКР
  3.2 Усиление ИКР (4 подшага)
  3.3 Обостренное противоречие (для X-элемента, инструмента, изделия, функции)
  3.4 Углублённое ОП (ОП₁)
  3.5 Углубление ОП₂
  3.6 Углубление ОП₃

ЧАСТЬ 4. ПОЛУЧЕНИЕ РЕШЕНИЯ (шаги 4.1–4.8)
  4.1 Типовые преобразования
  4.2 Ресурсы
  4.3 Система стандартов
  4.4 Задачи-аналоги
  4.5 Технологические эффекты
  4.6 Приёмы (40 основных + 10 дополнительных + приёмы-антиприёмы)
  4.7 Шаг назад от ИКР
  4.8 Метод ММЧ
```

### 3.3. Режим «Автопилот»

LLM проходит все шаги самостоятельно, пользователь получает готовый отчёт. Используется для B2C-пользователей, которые не хотят вникать в методологию.

---

## 4. Архитектура промптов (Prompt Architecture)

Ключевой элемент — система промптов, превращающая LLM в ТРИЗ-эксперта.

### 4.1. Иерархия промптов

```
SYSTEM PROMPT (Master)
│
├── ROLE PROMPT
│   «Ты — эксперт по ТРИЗ с 30-летним опытом решения
│    изобретательских задач по методологии АРИЗ-2010»
│
├── METHODOLOGY PROMPT (из книги Петрова)
│   ├── Определения (Приложение 4 — 35 определений)
│   ├── Правила (28 правил формулировок)
│   ├── Логика АРИЗ (цепочки ПП→УП→ИКР→ОП→Р)
│   └── Проверка на ложность (5 пунктов)
│
├── STEP PROMPTS (для каждого шага АРИЗ)
│   ├── step_1_1_mini_task.txt
│   ├── step_1_2_conflicting_pair.txt
│   ├── step_1_3_deepened_contradiction.txt
│   ├── ...
│   └── step_4_8_mmch_method.txt
│
├── VALIDATION PROMPTS (проверка качества формулировок)
│   ├── validate_function_formulation.txt  (правила 4–11)
│   ├── validate_contradiction.txt         (правило 19)
│   ├── validate_specialterms.txt          (правило 15)
│   └── validate_conflict_amplification.txt (правила 22–24)
│
├── INFORMATION FUND PROMPTS
│   ├── 40_principles.txt
│   ├── resolution_techniques.txt (пространство/время/структура/условие)
│   ├── paired_techniques.txt     (Приложение 3)
│   └── effects_database.txt
│
└── AUDIENCE ADAPTERS
    ├── b2c_simplified.txt  — бытовой язык, без терминов
    └── b2b_professional.txt — полная терминология ТРИЗ
```

### 4.2. Пример Step Prompt (шаг 1.1 — Мини-задача)

```
## Контекст
Ты помогаешь пользователю сформулировать мини-задачу по АРИЗ-2010.

## Твои действия
1. Определи техническую систему (объект), в которой возникла задача.
   - Правило 1: Рассматривай конкретный объект в конкретных условиях.
   - Правило 2: Выбирай систему с нежелательным эффектом (НЭ).
   - Правило 3: Если систем несколько — бери самую производительную.

2. Сформулируй главную функцию (ГФ) системы.
   - Правило 5: Без указания на конкретное исполнение.
   - Правило 9: Глагол (инфинитив) + существительное (вин. падеж).
   - Правило 10: Без частицы «не» — функция позитивная.
   - Проверь по Правилу 11 (процедура а→б→в→г).

3. Определи компонентный состав.
   - Правило 12: Только элементы верхнего уровня.
   - Правило 14: Контроль «Сохранится ли задача без этого элемента?»

4. Замени спецтермины (Правило 15):
   узкоспециальные → общие → функциональные → бытовые

5. Выяви НЭ и сформулируй ожидаемый результат.

6. Собери всё в мини-задачу:
   «Система для [ГФ] состоит из [компоненты].
    НЭ: [описание].
    Необходимо при минимальных изменениях устранить [НЭ],
    сохранив [полезную функцию]»

## Формат ответа
Задай пользователю уточняющие вопросы, если информации недостаточно.
Выдай результат в структурированном виде с пояснениями.
```

---

## 5. Модель данных

### 5.1. Основные сущности

```
User
├── id, email, name, plan (free/pro/business)
├── created_at, settings (locale, mode preference)
└── organization_id (nullable, для B2B)

Problem (Задача)
├── id, user_id, title
├── original_description (исходная формулировка)
├── mode (express / full / autopilot)
├── domain (technical / business / everyday)
├── status (in_progress / completed / archived)
├── created_at, updated_at
└── final_report (JSON — итоговый отчёт)

ARIZSession (Сессия решения)
├── id, problem_id
├── current_step (1.1 / 1.2 / ... / 4.8)
├── current_part (1 / 2 / 3 / 4)
└── completed_at

StepResult (Результат шага)
├── id, session_id
├── step_code (1.1.1, 1.1.2, ..., 4.8.3)
├── step_name
├── user_input (что ввёл пользователь)
├── llm_output (что предложила LLM)
├── validated_result (финальная формулировка)
├── validation_notes (замечания валидации)
└── created_at

Contradiction (Противоречие)
├── id, session_id
├── type (surface / deepened / sharpened)
├── quality_a, quality_b
├── property_s, anti_property_s
└── formulation

IKR (Идеальный конечный результат)
├── id, session_id
├── formulation
├── strengthened_formulation
└── vpr_used (использованные ресурсы)

Solution (Решение)
├── id, session_id
├── method_used (типовое_преобразование / ресурсы / стандарты / ...)
├── description
├── novelty_score (оценка новизны)
└── feasibility_score (оценка реализуемости)

AnalogTask (Задача-аналог)
├── id, op_formulation
├── solution_principle
├── domain, source
└── embedding (вектор для поиска)
```

---

## 6. Архитектура бэкенда

### 6.1. Технологический стек

| Компонент | Технология | Обоснование |
|-----------|-----------|-------------|
| API | Django + DRF | Твой основной стек, зрелый фреймворк |
| Async задачи | Celery + Redis | LLM-вызовы длительные, нужна асинхронность |
| LLM | Claude API (Sonnet 4) | Лучшее соотношение цена/качество для пошагового анализа |
| БД | PostgreSQL | Основное хранилище |
| Кэш/Сессии | Redis | Состояние АРИЗ-сессий |
| Поиск аналогов | pgvector | Векторный поиск задач-аналогов |
| Фронтенд | React + TypeScript | Или Lovable.dev для быстрого MVP |
| Деплой | Render.com | Быстрый старт |

### 6.2. Структура Django-приложений

```
triz_solver/
├── config/              — настройки Django
├── apps/
│   ├── users/           — авторизация, профили, подписки
│   ├── problems/        — задачи пользователей
│   ├── ariz_engine/     — ЯДРО: логика АРИЗ-2010
│   │   ├── models.py    — ARIZSession, StepResult, Contradiction, IKR, Solution
│   │   ├── steps/       — модули для каждого шага АРИЗ
│   │   │   ├── part1_analysis.py
│   │   │   ├── part2_resources.py
│   │   │   ├── part3_contradiction.py
│   │   │   └── part4_solution.py
│   │   ├── validators/  — валидация формулировок (правила 1–28)
│   │   ├── prompts/     — шаблоны промптов
│   │   └── modes/       — express.py, full.py, autopilot.py
│   ├── knowledge_base/  — информационный фонд ТРИЗ
│   │   ├── principles/  — 40 приёмов + 10 дополнительных
│   │   ├── effects/     — физические, химические, био, геометрические
│   │   ├── standards/   — система стандартов
│   │   ├── paired_techniques/  — приёмы-антиприёмы (Приложение 3)
│   │   └── analogs/     — база задач-аналогов
│   ├── llm_service/     — интеграция с Claude API
│   │   ├── client.py    — API-клиент
│   │   ├── prompts.py   — загрузка и рендеринг промптов
│   │   └── chains.py    — цепочки вызовов для шагов АРИЗ
│   └── reports/         — генерация отчётов (PDF, DOCX)
├── prompts/             — текстовые файлы промптов
│   ├── system/
│   ├── steps/
│   ├── validation/
│   └── adapters/
└── tests/
```

---

## 7. Пользовательский flow

### 7.1. B2C — «Экспресс-решение»

```
[Пользователь описывает проблему свободным текстом]
        │
        ▼
[Проверка на ложность] ← LLM проверяет 5 пунктов
        │
   ┌────┴────┐
   │ ложная  │ настоящая
   │проблема │ проблема
   ▼         ▼
[Объяснение] [Краткий АРИЗ: 7 шагов в формате диалога]
              │
              ├── Шаг 1: «Расскажите подробнее о ситуации...»
              ├── Шаг 2: «Что именно вас не устраивает? (НЭ)»
              ├── Шаг 3: «Если сделать X, то... а если Y, то...» (УП)
              ├── Шаг 4: «В идеале, результат был бы...» (ИКР)
              ├── Шаг 5: «Получается, нужно одновременно...» (ОП)
              ├── Шаг 6: «Углубим: почему именно...» (ОП₁)
              └── Шаг 7: «Вот возможные решения:» (Р)
                         ├── Разделение в пространстве
                         ├── Разделение во времени
                         ├── Изменение структуры
                         └── Разделение по условию
              │
              ▼
[Карточка решения + объяснение хода рассуждений]
```

### 7.2. B2B — «Полный анализ»

```
[Описание задачи] → [Предварительная проверка]
        │
        ▼
[Часть 1: Анализ] ← пошаговый диалог с валидацией
  │ 1.1 Мини-задача (с заменой спецтерминов)
  │ 1.2 Конфликтующая пара
  │ 1.3 УП₁ и УП₂
  │ 1.4 Выбор УП
  │ 1.5 Усиление конфликта
  │ 1.6 Модель задачи
  │ 1.7 Вепольный анализ
  ▼
[Часть 2: Ресурсы]
  │ 2.1 ОЗ — оперативная зона
  │ 2.2 ОВ — оперативное время
  │ 2.3 ВПР — таблица ресурсов
  ▼
[Часть 3: ОП]
  │ 3.1 ИКР
  │ 3.2 Усиленный ИКР
  │ 3.3 ОП (для X-элемента, инструмента, изделия, функции)
  │ 3.4–3.6 Углубление ОП
  ▼
[Часть 4: Решение]
  │ Параллельный поиск по всем инструментам:
  │ ├── Типовые преобразования
  │ ├── Ресурсы системы/надсистемы/среды
  │ ├── Система стандартов
  │ ├── Задачи-аналоги (векторный поиск)
  │ ├── Эффекты (физ/хим/био/геом)
  │ ├── 40+10 приёмов + приёмы-антиприёмы
  │ ├── Шаг назад от ИКР
  │ └── Метод ММЧ
  ▼
[Ранжирование решений: новизна × реализуемость]
        │
        ▼
[Структурированный отчёт (PDF/DOCX)]
```

---

## 8. Информационный фонд (Knowledge Base)

Структурированная база знаний ТРИЗ, загружаемая из книги и дополнительных источников:

| Раздел | Содержание | Формат хранения |
|--------|-----------|-----------------|
| 40 приёмов | Основные приёмы устранения ТП | JSON + embeddings |
| 10 доп. приёмов | Дополнительные приёмы | JSON + embeddings |
| Парные приёмы | Приём–антиприём (Прил. 3) | JSON |
| Физ. эффекты | Указатель физических эффектов | JSON + embeddings |
| Хим. эффекты | Указатель химических эффектов | JSON + embeddings |
| Био. эффекты | Указатель биологических эффектов | JSON + embeddings |
| Геом. эффекты | Указатель геометрических эффектов | JSON + embeddings |
| Стандарты | 76 стандартов на решение задач | JSON |
| Задачи-аналоги | Разобранные задачи (Глава 6 + внешние) | JSON + embeddings |
| Определения | 35 определений (Прил. 4) | JSON |
| Правила | 28 правил формулировок | JSON |
| Типовые преобразования | Таблица разрешения ОП | JSON |

---

## 9. Интеграция с LLM (Claude API)

### 9.1. Стратегия вызовов

```python
# Каждый шаг АРИЗ = отдельный вызов LLM с контекстом

class ARIZStepChain:
    def execute_step(self, step_code, context):
        """
        context содержит:
        - problem_description: исходная задача
        - previous_steps: результаты предыдущих шагов
        - current_step_prompt: промпт для текущего шага
        - validation_rules: правила для валидации
        - audience: b2c / b2b
        """
        
        # 1. Формируем системный промпт
        system = self.build_system_prompt(step_code, context.audience)
        
        # 2. Формируем контекст из предыдущих шагов
        history = self.build_step_history(context.previous_steps)
        
        # 3. Вызываем LLM
        response = claude_client.messages.create(
            model="claude-sonnet-4-20250514",
            system=system,
            messages=[
                {"role": "user", "content": history + context.user_input}
            ]
        )
        
        # 4. Валидируем результат
        validated = self.validate(step_code, response, context)
        
        return validated
```

### 9.2. Оптимизация стоимости

- **Краткий АРИЗ (B2C)**: ~7 вызовов Sonnet → ~$0.02-0.05 за задачу
- **Полный АРИЗ (B2B)**: ~15-30 вызовов Sonnet → ~$0.10-0.30 за задачу
- **Автопилот**: 1-3 вызова с большим контекстом → ~$0.05-0.15 за задачу
- **Кэширование**: типовые валидации и шаблоны в Redis

---

## 10. MVP — план реализации

### Фаза 1: Ядро (4 недели)

- [ ] Django-проект + модели данных
- [ ] Промпты для Краткого АРИЗ (7 шагов)
- [ ] Интеграция Claude API
- [ ] Валидаторы для ключевых правил (15, 19, 22-24)
- [ ] Минимальный REST API

### Фаза 2: Фронтенд (3 недели)

- [ ] React SPA — чат-интерфейс с визуализацией шагов
- [ ] Прогресс-бар по шагам АРИЗ
- [ ] Карточки решений
- [ ] Адаптивный дизайн (mobile-first)

### Фаза 3: Информационный фонд (2 недели)

- [ ] Загрузка 40 приёмов + парных приёмов
- [ ] Типовые преобразования
- [ ] База задач-аналогов (из Главы 6 + расширение)
- [ ] Векторный поиск аналогов

### Фаза 4: B2B расширение (3 недели)

- [ ] Полный АРИЗ-2010 (все 4 части)
- [ ] Генерация отчётов PDF/DOCX
- [ ] Командная работа
- [ ] Биллинг и подписки

---

## 11. Метрики успеха

| Метрика | Цель (3 мес.) | Цель (6 мес.) |
|---------|---------------|---------------|
| MAU | 500 | 5,000 |
| Решённых задач | 2,000 | 20,000 |
| Конверсия Free→Pro | 5% | 8% |
| Средний NPS | 40 | 55 |
| Retention D30 | 20% | 35% |
| Время решения (экспресс) | < 10 мин | < 7 мин |
